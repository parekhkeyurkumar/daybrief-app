<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Your day in ninety-nine words. One less than perfect, just like life.">
  <title>NinetyNine Words</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìî</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
      padding-top: 80px; /* Space for fixed header on mobile */
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 998;
      transition: box-shadow 0.3s ease;
    }

    .header.scrolled {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .header-content {
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      padding: 16px 20px;
      gap: 16px;
    }

    .header-branding {
      flex: 1;
      text-align: center;
    }
    
    h1 {
      color: #333;
      font-size: 20px;
      margin: 0;
      font-weight: 700;
    }

    .tagline {
      color: #666;
      font-size: 13px;
      margin-top: 4px;
      display: none; /* Hidden on mobile by default */
    }

    .tagline strong {
      color: #764ba2;
    }

    /* Integrated Hamburger Button */
    .hamburger-btn {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
      border-radius: 8px;
      min-width: 40px;
      height: 40px;
    }

    .hamburger-btn:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .hamburger-btn:active {
      transform: scale(0.95);
    }

    /* Desktop styles */
    @media (min-width: 768px) {
      body {
        padding-top: 120px; /* More space for taller desktop header */
      }

      .header-content {
        padding: 24px 20px;
      }

      h1 {
        font-size: 28px;
      }

      .tagline {
        display: block; /* Show taglines on desktop */
        font-size: 14px;
      }
    }
    
    .write-section {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .search-section {
      background: white;
      padding: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 15px;
      font-size: 18px;
      pointer-events: none;
      color: #999;
    }

    #searchInput {
      width: 100%;
      padding: 12px 45px 12px 45px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    #searchInput:focus {
      outline: none;
      border-color: #667eea;
    }

    .clear-search {
      position: absolute;
      right: 15px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .clear-search:hover {
      background: #e0e0e0;
      color: #333;
    }

    .clear-search.visible {
      display: flex;
    }

    .search-results {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .search-results.no-results {
      color: #f5576c;
    }

    .mood-selector {
      margin-bottom: 20px;
      text-align: center;
    }

    .mood-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .mood-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .mood-btn {
      font-size: 32px;
      padding: 10px 15px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mood-btn:hover {
      transform: scale(1.1);
      border-color: #667eea;
    }

    .mood-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      transform: scale(1.15);
    }
    
    textarea { 
      width: 100%; 
      height: 150px; 
      font-size: 16px; 
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.3s;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .word-count { 
      color: #666; 
      margin-top: 8px;
      font-size: 14px;
    }
    
    .warning { 
      color: #f5576c;
      font-weight: bold;
    }
    
    .save-btn { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      padding: 14px 35px; 
      border: none; 
      border-radius: 12px; 
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    
    .save-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .save-btn:active {
      transform: translateY(0);
    }
    
    .entries { 
      margin-top: 20px;
    }
    
    .entries-header {
      background: white;
      padding: 20px 30px;
      border-radius: 16px;
      margin-bottom: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .entries-header h2 {
      color: #333;
      font-size: 24px;
    }
    
    .entry { 
      background: white;
      padding: 25px; 
      margin: 15px 0; 
      border-radius: 16px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      border-left: 5px solid #667eea;
      transition: transform 0.2s;
    }
    
    .entry:hover {
      transform: translateX(5px);
    }
    
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .entry-date { 
      color: #999; 
      font-size: 13px; 
      font-weight: 600;
    }

    .entry-mood {
      font-size: 28px;
      margin-right: 15px;
      cursor: help;
      flex-shrink: 0;
    }

    .edit-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-btn:hover {
      background: #764ba2;
      transform: scale(1.05);
    }

    .delete-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      background: #ee5a6f;
      transform: scale(1.05);
    }

    .save-edit-btn {
      background: #10ac84;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-edit-btn:hover {
      background: #0e9770;
      transform: scale(1.05);
    }

    .cancel-edit-btn {
      background: #999;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cancel-edit-btn:hover {
      background: #777;
      transform: scale(1.05);
    }

    .entry.editing {
      border-left-color: #10ac84;
    }

    .entry-edit-textarea {
      width: 100%;
      min-height: 100px;
      font-size: 15px;
      padding: 12px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 10px;
    }

    .entry-edit-textarea:focus {
      outline: none;
      border-color: #764ba2;
    }

    .entry-edit-word-count {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }

    .entry-edit-word-count.warning {
      color: #f5576c;
      font-weight: bold;
    }

    .entry-mood-selector {
      margin-bottom: 15px;
    }

    .entry-mood-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .entry-mood-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .entry-mood-btn {
      font-size: 24px;
      padding: 6px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .entry-mood-btn:hover {
      transform: scale(1.1);
      border-color: #667eea;
    }

    .entry-mood-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      transform: scale(1.1);
    }
    
    .entry-text {
      color: #333;
      line-height: 1.6;
      font-size: 15px;
    }
    
    .no-entries {
      background: white;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      color: #999;
      font-style: italic;
    }

    .footer {
      text-align: center;
      color: white;
      padding: 20px;
      opacity: 0.8;
      font-size: 14px;
      margin-top: 40px;
    }

    /* Old hamburger styles removed - now integrated in header */

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100vh;
      background: white;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-header {
      padding: 30px 20px 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .sidebar-logo {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .sidebar-close:hover {
      background: #e0e0e0;
      color: #333;
      transform: scale(1.1);
    }

    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      color: #666;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: #f5f5f5;
      color: #333;
    }

    .nav-item.active {
      background: #f0f4ff;
      color: #667eea;
      border-left: 4px solid #667eea;
      padding-left: 20px;
    }

    .nav-item-icon {
      font-size: 20px;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      color: #999;
      font-size: 13px;
      font-style: italic;
    }

    /* Backdrop */
    .backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .backdrop.visible {
      opacity: 1;
      visibility: visible;
    }

    /* View sections */
    .view-section {
      display: none;
    }

    .view-section.active {
      display: block;
    }

    /* Insights view */
    .insights-view {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .insights-placeholder {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .insights-text {
      font-size: 20px;
      color: #666;
      font-weight: 500;
    }

    /* Time filter */
    .time-filter {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .time-filter-btn {
      padding: 12px 24px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      color: #666;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .time-filter-btn:hover {
      border-color: #667eea;
      color: #667eea;
      transform: translateY(-2px);
    }

    .time-filter-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    /* Empty states */
    .insights-empty {
      background: white;
      padding: 60px 40px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    .insights-empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .insights-empty-text {
      font-size: 18px;
      color: #666;
      line-height: 1.6;
    }

    /* Insight cards */
    .insight-card {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }

    .insight-card-header {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .insight-card-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Mood bar chart */
    .mood-bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mood-bar-label {
      min-width: 120px;
      font-size: 15px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mood-bar-container {
      flex: 1;
      height: 32px;
      background: #f5f5f5;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .mood-bar-fill {
      height: 100%;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      padding-left: 10px;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .mood-bar-percentage {
      min-width: 45px;
      text-align: right;
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    /* Mood colors */
    .mood-happy { background: #F59E0B; }
    .mood-thoughtful { background: #3B82F6; }
    .mood-neutral { background: #6B7280; }
    .mood-tired { background: #8B5CF6; }
    .mood-angry { background: #EF4444; }
    .mood-sad { background: #06B6D4; }

    /* Insight footer */
    .insight-footer {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f5f5f5;
      font-size: 15px;
      color: #666;
      font-weight: 500;
    }

    /* Pattern stats */
    .pattern-stat {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      font-size: 15px;
      color: #333;
    }

    .pattern-stat strong {
      color: #667eea;
      font-weight: 700;
    }

    .pattern-stat-label {
      color: #999;
      font-size: 13px;
      margin-top: 4px;
    }

    /* Word count chart */
    .word-count-chart {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .word-count-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .word-count-mood {
      min-width: 100px;
      font-size: 14px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .word-count-bar {
      flex: 1;
      height: 24px;
      background: #f5f5f5;
      border-radius: 6px;
      overflow: hidden;
    }

    .word-count-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    @media (max-width: 600px) {
      .mood-bar-label {
        min-width: 90px;
        font-size: 14px;
      }

      .insight-card {
        padding: 20px;
      }

      .time-filter {
        padding: 15px;
      }
    }

    /* Streak Counter */
    .streak-counter {
      background: linear-gradient(135deg, rgba(255, 183, 77, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
      border: 2px solid rgba(255, 152, 0, 0.2);
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 25px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .streak-counter.pulse {
      animation: streakPulse 0.6s ease-out;
    }

    @keyframes streakPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(255, 152, 0, 0.3);
      }
    }

    .streak-text {
      font-size: 18px;
      font-weight: 600;
      color: #e65100;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    @media (max-width: 500px) {
      .streak-text {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Unified Sticky Header -->
  <div class="header" id="stickyHeader">
    <div class="header-content">
      <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
      <div class="header-branding">
        <h1>üìî NinetyNine Words</h1>
        <p class="tagline">Your daily journal in 99 words.<br><strong>One less than perfect, just like life.</strong></p>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div class="backdrop" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">üìì NinetyNine Words</div>
      <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
    </div>
    <nav class="sidebar-nav">
      <button class="nav-item active" onclick="switchView('capture', event)">
        <span class="nav-item-icon">‚úèÔ∏è</span>
        <span>Capture</span>
      </button>
      <button class="nav-item" onclick="switchView('insights', event)">
        <span class="nav-item-icon">üìä</span>
        <span>Insights</span>
      </button>
    </nav>
    <div class="sidebar-footer">
      Write less. Remember more.
    </div>
  </div>

  <div class="container">
    <!-- Capture View (Default) -->
    <div class="view-section active" id="captureView">

      <div class="write-section">
      <!-- Streak Counter -->
      <div class="streak-counter" id="streakCounter">
        <div class="streak-text">
          <span id="streakMessage">Start your streak today! üî•</span>
        </div>
      </div>

      <div class="mood-selector">
        <div class="mood-label">Pick your mood</div>
        <div class="mood-buttons">
          <button type="button" class="mood-btn" data-mood="üòä" onclick="selectMood('üòä', event)" title="Happy">üòä</button>
          <button type="button" class="mood-btn" data-mood="ü§î" onclick="selectMood('ü§î', event)" title="Thoughtful">ü§î</button>
          <button type="button" class="mood-btn" data-mood="üòê" onclick="selectMood('üòê', event)" title="Neutral">üòê</button>
          <button type="button" class="mood-btn" data-mood="üò¥" onclick="selectMood('üò¥', event)" title="Tired">üò¥</button>
          <button type="button" class="mood-btn" data-mood="üò§" onclick="selectMood('üò§', event)" title="Angry">üò§</button>
          <button type="button" class="mood-btn" data-mood="üò¢" onclick="selectMood('üò¢', event)" title="Sad">üò¢</button>
        </div>
      </div>

      <textarea id="diaryEntry" placeholder="What's worth remembering today?"></textarea>
      <div class="word-count" id="wordCount">0 / 99 words</div>
      <button class="save-btn" onclick="saveEntry()">üìå Keep it</button>
    </div>

    <div class="search-section">
      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          id="searchInput"
          placeholder="Find a memory..."
          oninput="handleSearch()"
        />
        <button class="clear-search" id="clearSearch" onclick="clearSearch()">‚úï</button>
      </div>
      <div class="search-results" id="searchResults"></div>
    </div>

      <div class="entries" id="entriesList"></div>
    </div>

    <!-- Insights View -->
    <div class="view-section" id="insightsView">
      <div class="insights-view" id="insightsContent">
        <!-- Dynamic insights content will be inserted here -->
      </div>
    </div>

    <div class="footer">
      Write less. Remember more.
    </div>
  </div>

  <script>
    let selectedMood = null;
    let editingEntryId = null;
    let editingMood = null;
    let currentView = 'capture';
    let currentTimeFilter = 'all'; // 'week', 'month', 'all'

    // Calculate current streak
    function calculateStreak() {
      const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');

      if (entries.length === 0) {
        return { streak: 0, hasEntryToday: false, hasEntryYesterday: false };
      }

      // Get all unique dates (YYYY-MM-DD format in local time)
      const uniqueDates = new Set();
      entries.forEach(entry => {
        const date = new Date(entry.timestamp);
        const dateStr = date.getFullYear() + '-' +
                       String(date.getMonth() + 1).padStart(2, '0') + '-' +
                       String(date.getDate()).padStart(2, '0');
        uniqueDates.add(dateStr);
      });

      // Convert to sorted array (most recent first)
      const sortedDates = Array.from(uniqueDates).sort().reverse();

      // Get today's date string
      const today = new Date();
      const todayStr = today.getFullYear() + '-' +
                      String(today.getMonth() + 1).padStart(2, '0') + '-' +
                      String(today.getDate()).padStart(2, '0');

      // Get yesterday's date string
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.getFullYear() + '-' +
                          String(yesterday.getMonth() + 1).padStart(2, '0') + '-' +
                          String(yesterday.getDate()).padStart(2, '0');

      const hasEntryToday = sortedDates.includes(todayStr);
      const hasEntryYesterday = sortedDates.includes(yesterdayStr);

      // Calculate streak
      let streak = 0;
      const startDate = hasEntryToday ? todayStr : yesterdayStr;

      // If no entry today or yesterday, streak is broken
      if (!hasEntryToday && !hasEntryYesterday) {
        return { streak: 0, hasEntryToday: false, hasEntryYesterday: false };
      }

      // Count consecutive days
      // Parse date string as local time to avoid timezone issues
      const [startYear, startMonth, startDay] = startDate.split('-').map(Number);
      let checkDate = new Date(startYear, startMonth - 1, startDay);

      while (true) {
        const checkDateStr = checkDate.getFullYear() + '-' +
                            String(checkDate.getMonth() + 1).padStart(2, '0') + '-' +
                            String(checkDate.getDate()).padStart(2, '0');

        if (sortedDates.includes(checkDateStr)) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else {
          break;
        }
      }

      return { streak, hasEntryToday, hasEntryYesterday };
    }

    // Update streak display
    function updateStreakDisplay(animate = false) {
      const { streak, hasEntryToday, hasEntryYesterday } = calculateStreak();
      const messageEl = document.getElementById('streakMessage');
      const counterEl = document.getElementById('streakCounter');

      let message = '';

      if (streak === 0) {
        // No entries ever
        message = 'Start your streak today!';
      } else if (!hasEntryToday && hasEntryYesterday) {
        // Wrote yesterday but not today
        message = `üî• ${streak} day${streak !== 1 ? 's' : ''} ‚Äî keep it going!`;
      } else if (hasEntryToday) {
        // Wrote today
        if (streak === 99) {
          message = 'üî• 99 days! One less than perfect!';
        } else if (streak === 1) {
          message = 'üî• 1 day streak!';
        } else if (streak === 7) {
          message = 'üî• 1 week strong!';
        } else if (streak === 30) {
          message = 'üî• 1 month strong!';
        } else if (streak >= 60 && streak % 30 === 0) {
          const months = Math.floor(streak / 30);
          message = `üî• ${months} months strong!`;
        } else {
          message = `üî• ${streak} day${streak !== 1 ? 's' : ''}!`;
        }
      }

      messageEl.textContent = message;

      // Add pulse animation if requested
      if (animate) {
        counterEl.classList.remove('pulse');
        // Force reflow to restart animation
        void counterEl.offsetWidth;
        counterEl.classList.add('pulse');

        setTimeout(() => {
          counterEl.classList.remove('pulse');
        }, 600);
      }
    }

    // Scroll shadow effect for sticky header
    window.addEventListener('scroll', function() {
      const header = document.getElementById('stickyHeader');
      if (window.scrollY > 10) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.querySelector('.backdrop');
      sidebar.classList.toggle('open');
      backdrop.classList.toggle('visible');
    }

    function closeSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.querySelector('.backdrop');
      sidebar.classList.remove('open');
      backdrop.classList.remove('visible');
    }

    // View switching
    function switchView(viewName, event) {
      currentView = viewName;

      // Hide all views
      document.querySelectorAll('.view-section').forEach(view => {
        view.classList.remove('active');
      });

      // Show selected view
      if (viewName === 'capture') {
        document.getElementById('captureView').classList.add('active');
      } else if (viewName === 'insights') {
        document.getElementById('insightsView').classList.add('active');
        // Refresh insights when switching to insights view
        renderInsights();
      }

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.nav-item').classList.add('active');

      // Close sidebar
      closeSidebar();
    }

    // Mood to placeholder mapping
    const moodPlaceholders = {
      'üòä': "What made you smile?",
      'ü§î': "What's on your mind?",
      'üòê': "Even ordinary days matter.",
      'üò¥': "Too tired to talk? Type instead.",
      'üò§': "Let it out. No judgement.",
      'üò¢': "Want to get it off your chest?"
    };

    // Mood to name mapping for tooltips
    const moodNames = {
      'üòä': "Happy",
      'ü§î': "Thoughtful",
      'üòê': "Neutral",
      'üò¥': "Tired",
      'üò§': "Angry",
      'üò¢': "Sad"
    };

    const defaultPlaceholder = "What's worth remembering today?";

    // Select mood when user clicks emoji
    function selectMood(mood, event) {
      selectedMood = mood;

      document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');

      // Update textarea placeholder based on selected mood
      const textarea = document.getElementById('diaryEntry');
      textarea.placeholder = moodPlaceholders[mood] || defaultPlaceholder;
    }

    // Handle search input
    function handleSearch() {
      const searchInput = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearch');
      const query = searchInput.value.trim();

      // Show/hide clear button
      if (query) {
        clearBtn.classList.add('visible');
      } else {
        clearBtn.classList.remove('visible');
      }

      // Filter and display entries
      displayEntries(query);
    }

    // Clear search
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearch').classList.remove('visible');
      document.getElementById('searchResults').textContent = '';
      displayEntries();
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Highlight search terms in text
    function highlightText(text, query) {
      if (!query) return escapeHtml(text);

      // Escape the text first
      const escapedText = escapeHtml(text);
      const escapedQuery = escapeHtml(query);

      // Then highlight the query
      const regex = new RegExp(`(${escapedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escapedText.replace(regex, '<mark style="background-color: #fff176; padding: 2px 0; border-radius: 2px;">$1</mark>');
    }

    // Count words as user types
    document.getElementById('diaryEntry').addEventListener('input', function() {
      const text = this.value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;
      const counter = document.getElementById('wordCount');
      
      if (words > 99) {
        counter.classList.add('warning');
        counter.textContent = words + ' / 99 words - Too many words!';
      } else {
        counter.classList.remove('warning');
        counter.textContent = words + ' / 99 words';
      }
    });

    // Save entry to localStorage
    function saveEntry() {
      const text = document.getElementById('diaryEntry').value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;
      
      // Validation
      if (text === '') {
        alert('‚úçÔ∏è Write something first!');
        return;
      }
      
      if (words > 99) {
        alert('üìù Please keep it under 99 words!');
        return;
      }

      if (!selectedMood) {
        alert('üòä Pick a mood first!');
        return;
      }
      
      // Get existing entries
      let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      
      // Create new entry
      const newEntry = {
        id: Date.now(),
        text: text,
        mood: selectedMood,
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('en-US', { 
          weekday: 'short',
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }),
        words: words
      };
      
      // Add to beginning of array
      entries.unshift(newEntry);
      
      // Save to localStorage
      localStorage.setItem('diaryEntries', JSON.stringify(entries));
      
      // Clear form
      const textarea = document.getElementById('diaryEntry');
      textarea.value = '';
      textarea.placeholder = defaultPlaceholder;
      document.getElementById('wordCount').textContent = '0 / 99 words';
      selectedMood = null;
      document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Refresh display
      displayEntries();

      // Update streak counter with animation
      updateStreakDisplay(true);

      // Refresh insights
      renderInsights();

      alert('‚úÖ Entry saved successfully!');
    }

    // Edit entry
    function editEntry(id) {
      // Prevent editing multiple entries at once
      if (editingEntryId !== null && editingEntryId !== id) {
        alert('‚ö†Ô∏è Please save or cancel the current edit first!');
        return;
      }

      editingEntryId = id;
      const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      const entry = entries.find(e => e.id === id);

      if (!entry) return;

      editingMood = entry.mood;
      displayEntries();
    }

    // Select mood for entry being edited
    function selectEditMood(mood, entryId, event) {
      editingMood = mood;

      // Update button states
      document.querySelectorAll(`[data-entry-mood-btn="${entryId}"]`).forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }

    // Update word count for entry being edited
    function updateEditWordCount(entryId) {
      const textarea = document.getElementById(`edit-textarea-${entryId}`);
      const counter = document.getElementById(`edit-word-count-${entryId}`);

      const text = textarea.value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;

      if (words > 99) {
        counter.classList.add('warning');
        counter.textContent = words + ' / 99 words - Too many words!';
      } else {
        counter.classList.remove('warning');
        counter.textContent = words + ' / 99 words';
      }
    }

    // Save edited entry
    function saveEdit(id) {
      const textarea = document.getElementById(`edit-textarea-${id}`);
      const text = textarea.value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;

      // Validation
      if (text === '') {
        alert('‚úçÔ∏è Entry cannot be empty!');
        return;
      }

      if (words > 99) {
        alert('üìù Please keep it under 99 words!');
        return;
      }

      if (!editingMood) {
        alert('üòä Pick a mood!');
        return;
      }

      // Get existing entries
      let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');

      // Find and update the entry
      const entryIndex = entries.findIndex(e => e.id === id);
      if (entryIndex !== -1) {
        entries[entryIndex].text = text;
        entries[entryIndex].mood = editingMood;
        entries[entryIndex].words = words;
      }

      // Save to localStorage
      localStorage.setItem('diaryEntries', JSON.stringify(entries));

      // Reset editing state
      editingEntryId = null;
      editingMood = null;

      // Refresh display
      displayEntries();

      // Update streak counter (no animation for edits)
      updateStreakDisplay();

      // Refresh insights
      renderInsights();

      alert('‚úÖ Entry updated successfully!');
    }

    // Cancel edit
    function cancelEdit() {
      editingEntryId = null;
      editingMood = null;
      displayEntries();
    }

    // Delete entry
    function deleteEntry(id) {
      if (!confirm('Are you sure you want to delete this entry?')) {
        return;
      }

      let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      entries = entries.filter(entry => entry.id !== id);
      localStorage.setItem('diaryEntries', JSON.stringify(entries));

      displayEntries();

      // Update streak counter (deleting might break the streak)
      updateStreakDisplay();

      // Refresh insights
      renderInsights();

      alert('üóëÔ∏è Entry deleted!');
    }

    // Display all entries
    function displayEntries(searchQuery = '') {
      const allEntries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      const container = document.getElementById('entriesList');
      const searchResultsDiv = document.getElementById('searchResults');

      // Filter entries based on search query
      let entries = allEntries;
      if (searchQuery) {
        entries = allEntries.filter(entry =>
          entry.text.toLowerCase().includes(searchQuery.toLowerCase())
        );
      }

      // Update search results message
      if (searchQuery) {
        if (entries.length === 0) {
          searchResultsDiv.textContent = 'No memories found';
          searchResultsDiv.classList.add('no-results');
        } else {
          searchResultsDiv.textContent = `${entries.length} memor${entries.length !== 1 ? 'ies' : 'y'} found`;
          searchResultsDiv.classList.remove('no-results');
        }
      } else {
        searchResultsDiv.textContent = '';
        searchResultsDiv.classList.remove('no-results');
      }

      if (allEntries.length === 0) {
        container.innerHTML = `
          <div class="no-entries">
            Your first 99 words start here.
          </div>
        `;
        return;
      }

      if (entries.length === 0 && searchQuery) {
        container.innerHTML = `
          <div class="entries-header">
            <h2>üìÖ Your Days</h2>
          </div>
          <div class="no-entries">
            No memories match. Try different words?
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="entries-header">
          <h2>üìÖ Your Days</h2>
        </div>
      ` + entries.map(entry => {
        const isEditing = editingEntryId === entry.id;

        if (isEditing) {
          // Edit mode
          return `
            <div class="entry editing">
              <div class="entry-header">
                <div>
                  <div class="entry-date">${entry.date}</div>
                </div>
              </div>
              <div class="entry-mood-selector">
                <div class="entry-mood-label">Pick your mood</div>
                <div class="entry-mood-buttons">
                  <button type="button" class="entry-mood-btn ${editingMood === 'üòä' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üòä', ${entry.id}, event)">üòä</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'ü§î' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('ü§î', ${entry.id}, event)">ü§î</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üòê' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üòê', ${entry.id}, event)">üòê</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üò¥' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üò¥', ${entry.id}, event)">üò¥</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üò§' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üò§', ${entry.id}, event)">üò§</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üò¢' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üò¢', ${entry.id}, event)">üò¢</button>
                </div>
              </div>
              <textarea
                id="edit-textarea-${entry.id}"
                class="entry-edit-textarea"
                oninput="updateEditWordCount(${entry.id})"
              >${entry.text}</textarea>
              <div id="edit-word-count-${entry.id}" class="entry-edit-word-count">${entry.words} / 99 words</div>
              <div style="display: flex; gap: 10px;">
                <button class="save-edit-btn" onclick="saveEdit(${entry.id})">üíæ Save</button>
                <button class="cancel-edit-btn" onclick="cancelEdit()">‚úñÔ∏è Cancel</button>
              </div>
            </div>
          `;
        } else {
          // Normal display mode
          return `
            <div class="entry">
              <div class="entry-header">
                ${entry.mood ? `<span class="entry-mood" title="${moodNames[entry.mood] || ''}">${entry.mood}</span>` : ''}
                <div style="flex: 1;">
                  <div class="entry-date">${entry.date} ‚Ä¢ ${entry.words} words</div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <button class="edit-btn" onclick="editEntry(${entry.id})">‚úèÔ∏è Edit</button>
                  <button class="delete-btn" onclick="deleteEntry(${entry.id})">üóëÔ∏è Delete</button>
                </div>
              </div>
              <div class="entry-text">${highlightText(entry.text, searchQuery)}</div>
            </div>
          `;
        }
      }).join('');
    }

    // Insights Functions

    // Filter entries by time period
    function filterEntriesByTime(entries, filter) {
      if (filter === 'all') return entries;

      const now = new Date();
      const cutoffDate = new Date();

      if (filter === 'week') {
        cutoffDate.setDate(now.getDate() - 7);
      } else if (filter === 'month') {
        cutoffDate.setDate(now.getDate() - 30);
      }

      return entries.filter(entry => {
        const entryDate = new Date(entry.timestamp);
        return entryDate >= cutoffDate;
      });
    }

    // Get mood name from emoji
    function getMoodName(emoji) {
      return moodNames[emoji] || 'Unknown';
    }

    // Get mood CSS class from emoji
    function getMoodClass(emoji) {
      const classMap = {
        'üòä': 'mood-happy',
        'ü§î': 'mood-thoughtful',
        'üòê': 'mood-neutral',
        'üò¥': 'mood-tired',
        'üò§': 'mood-angry',
        'üò¢': 'mood-sad'
      };
      return classMap[emoji] || 'mood-neutral';
    }

    // Calculate mood breakdown
    function calculateMoodBreakdown(entries) {
      const moodCounts = {};

      entries.forEach(entry => {
        if (entry.mood) {
          moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
        }
      });

      // Convert to array and sort by count
      const moodStats = Object.keys(moodCounts).map(mood => ({
        emoji: mood,
        name: getMoodName(mood),
        count: moodCounts[mood],
        percentage: Math.round((moodCounts[mood] / entries.length) * 100)
      })).sort((a, b) => b.count - a.count);

      return moodStats;
    }

    // Calculate word usage patterns
    function calculateWordPatterns(entries) {
      if (entries.length === 0) return null;

      const totalWords = entries.reduce((sum, entry) => sum + entry.words, 0);
      const avgWords = Math.round(totalWords / entries.length);

      // Find longest and shortest entries
      let longest = entries[0];
      let shortest = entries[0];

      entries.forEach(entry => {
        if (entry.words > longest.words) longest = entry;
        if (entry.words < shortest.words) shortest = entry;
      });

      // Calculate average words per mood
      const moodWordCounts = {};
      const moodEntryCounts = {};

      entries.forEach(entry => {
        if (entry.mood) {
          moodWordCounts[entry.mood] = (moodWordCounts[entry.mood] || 0) + entry.words;
          moodEntryCounts[entry.mood] = (moodEntryCounts[entry.mood] || 0) + 1;
        }
      });

      const moodAverages = Object.keys(moodWordCounts).map(mood => ({
        emoji: mood,
        name: getMoodName(mood),
        avg: Math.round(moodWordCounts[mood] / moodEntryCounts[mood])
      })).sort((a, b) => b.avg - a.avg);

      // Find mood with most/least words
      let moodInsight = null;
      if (moodAverages.length > 0) {
        const maxMood = moodAverages[0];
        const minMood = moodAverages[moodAverages.length - 1];

        if (maxMood.avg > avgWords) {
          moodInsight = {
            mood: maxMood.emoji,
            name: maxMood.name,
            comparison: 'more',
            avg: maxMood.avg
          };
        } else if (minMood.avg < avgWords) {
          moodInsight = {
            mood: minMood.emoji,
            name: minMood.name,
            comparison: 'less',
            avg: minMood.avg
          };
        }
      }

      // Format longest entry date
      const longestDate = new Date(longest.timestamp).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      // Format shortest entry date
      const shortestDate = new Date(shortest.timestamp).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      return {
        avgWords,
        longest: { words: longest.words, date: longestDate },
        shortest: { words: shortest.words, date: shortestDate },
        moodAverages,
        moodInsight
      };
    }

    // Set time filter
    function setTimeFilter(filter) {
      currentTimeFilter = filter;
      renderInsights();
    }

    // Render insights
    function renderInsights() {
      const container = document.getElementById('insightsContent');
      const allEntries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      const filteredEntries = filterEntriesByTime(allEntries, currentTimeFilter);

      // Empty states
      if (filteredEntries.length === 0) {
        container.innerHTML = `
          <div class="insights-empty">
            <div class="insights-empty-icon">‚ú®</div>
            <div class="insights-empty-text">Your insights will appear here. Start with your first 99 words! ‚ú®</div>
          </div>
        `;
        return;
      }

      if (filteredEntries.length <= 2) {
        container.innerHTML = `
          <div class="insights-empty">
            <div class="insights-empty-icon">üìù</div>
            <div class="insights-empty-text">A few more entries and we'll spot some patterns... üìù</div>
          </div>
        `;
        return;
      }

      // Calculate insights
      const moodStats = calculateMoodBreakdown(filteredEntries);
      const wordPatterns = calculateWordPatterns(filteredEntries);

      // Build time filter buttons
      const timeFilterHTML = `
        <div class="time-filter">
          <button class="time-filter-btn ${currentTimeFilter === 'week' ? 'active' : ''}" onclick="setTimeFilter('week')">This Week</button>
          <button class="time-filter-btn ${currentTimeFilter === 'month' ? 'active' : ''}" onclick="setTimeFilter('month')">This Month</button>
          <button class="time-filter-btn ${currentTimeFilter === 'all' ? 'active' : ''}" onclick="setTimeFilter('all')">All Time</button>
        </div>
      `;

      // Build mood breakdown card
      let moodBreakdownHTML = `
        <div class="insight-card">
          <div class="insight-card-header">How You've Been Feeling</div>
          <div class="insight-card-content">
      `;

      moodStats.forEach(mood => {
        moodBreakdownHTML += `
          <div class="mood-bar-item">
            <div class="mood-bar-label">${mood.emoji} ${mood.name}</div>
            <div class="mood-bar-container">
              <div class="mood-bar-fill ${getMoodClass(mood.emoji)}" style="width: ${mood.percentage}%">
                ${mood.percentage >= 15 ? mood.percentage + '%' : ''}
              </div>
            </div>
            <div class="mood-bar-percentage">${mood.percentage}%</div>
          </div>
        `;
      });

      // Add footer with most common mood
      const topMood = moodStats[0];
      moodBreakdownHTML += `
          </div>
          <div class="insight-footer">
            Your most common mood is ${topMood.emoji} ${topMood.name}
          </div>
        </div>
      `;

      // Build word patterns card
      let wordPatternsHTML = `
        <div class="insight-card">
          <div class="insight-card-header">Your 99 Pattern ‚úçÔ∏è</div>
          <div class="insight-card-content">
      `;

      wordPatternsHTML += `
        <div class="pattern-stat">
          On average, you use <strong>${wordPatterns.avgWords}</strong> of your 99 words
        </div>
        <div class="pattern-stat">
          <strong>Longest entry:</strong> ${wordPatterns.longest.words} words
          <div class="pattern-stat-label">${wordPatterns.longest.date}</div>
        </div>
        <div class="pattern-stat">
          <strong>Shortest entry:</strong> ${wordPatterns.shortest.words} words
          <div class="pattern-stat-label">${wordPatterns.shortest.date}</div>
        </div>
      `;

      // Add mood word count chart
      if (wordPatterns.moodAverages.length > 0) {
        const maxAvg = Math.max(...wordPatterns.moodAverages.map(m => m.avg));

        wordPatternsHTML += `
          <div style="margin-top: 20px;">
            <div style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 10px;">Average words by mood:</div>
            <div class="word-count-chart">
        `;

        wordPatterns.moodAverages.forEach(mood => {
          const percentage = (mood.avg / maxAvg) * 100;
          wordPatternsHTML += `
            <div class="word-count-item">
              <div class="word-count-mood">${mood.emoji} ${mood.name}</div>
              <div class="word-count-bar">
                <div class="word-count-bar-fill" style="width: ${percentage}%">
                  ${mood.avg}
                </div>
              </div>
            </div>
          `;
        });

        wordPatternsHTML += `
            </div>
          </div>
        `;
      }

      // Add mood insight footer
      if (wordPatterns.moodInsight) {
        const insight = wordPatterns.moodInsight;
        wordPatternsHTML += `
          <div class="insight-footer">
            When ${insight.mood} ${insight.name}, you write ${insight.comparison} ‚Äî avg ${insight.avg} words
          </div>
        `;
      }

      wordPatternsHTML += `
          </div>
        </div>
      `;

      // Combine all HTML
      container.innerHTML = timeFilterHTML + moodBreakdownHTML + wordPatternsHTML;
    }

    // Load entries when page loads
    displayEntries();
    updateStreakDisplay();
    renderInsights();
  </script>
</body>
</html>
